<!DOCTYPE html>
<html lang="en">
<head>
    <title>LDAP</title>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage esqConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <form class="esqConfigurationForm">
                    <div class="verticalSection verticalSection-extrabottompadding">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h2 class="sectionTitle">LDAP Settings:</h2>
                            <a is="emby-button" class="raised button-alt headerHelpButton" target="_blank" href="https://github.com/jellyfin/jellyfin-plugin-ldapauth">${Help}</a>
                        </div>
                        <p><i>Note:</i> Making changes to this configuration requires a restart of Jellyfin.</p>
                        <div class="verticalSection verticalSection-extrabottompadding">
                            <div class="inputContainer">
                                <input is="emby-input" type="text" id="txtLdapServer" label="LDAP Server:" />
                                <div class="fieldDescription">The server name for the LDAP server you wish to use for Authentication.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label>
                                    <input type="checkbox" is="emby-checkbox" id="chkUseSsl" />
                                    <span>Secure LDAP:</span>
                                </label>
                                <div class="fieldDescription checkboxFieldDescription">Use SSL for the LDAP connection.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label>
                                    <input type="checkbox" is="emby-checkbox" id="chkUseStartTls" />
                                    <span>STARTTLS:</span>
                                </label>
                                <div class="fieldDescription checkboxFieldDescription">Use STARTTLS for the LDAP connection.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label>
                                    <input type="checkbox" is="emby-checkbox" id="chkSkipSslVerify" />
                                    <span>Skip SSL/TLS Verification:</span>
                                </label>
                                <div class="fieldDescription checkboxFieldDescription">Skip verification of connection certificate when using SSL/STARTTLS.</div>
                            </div>
                            <div class="inputContainer fldExternalAddressFilter">
                                <input is="emby-input" type="text" id="txtLdapBaseDn" label="LDAP Base DN for searches:" />
                                <div class="fieldDescription">The base DN for your LDAP query.</div>
                            </div>
                            <div class="inputContainer fldExternalAddressFilter">
                                <input is="emby-input" type="number" id="txtLdapPort" label="LDAP Port:" />
                                <div class="fieldDescription">The port to communicate with LDAP.</div>
                            </div>
                            <div class="inputContainer fldExternalAddressFilter">
                                <input is="emby-input" type="text" id="txtLdapSearchAttributes" label="LDAP Attributes:" />
                                <div class="fieldDescription">A comma-separated list of LDAP attributes to compare with entered usernames.</div>
                            </div>
                            <div class="inputContainer fldExternalAddressFilter">
                                <input is="emby-input" type="text" id="txtLdapUsernameAttribute" label="LDAP Name Attribute:" />
                                <div class="fieldDescription">The LDAP attribute to create Jellyfin user names from.</div>
                            </div>
                            <div class="inputContainer fldExternalAddressFilter">
                                <input is="emby-input" type="text" id="txtLdapSearchFilter" label="LDAP User Filter:" />
                                <div class="fieldDescription">The LDAP search filter to find users for Jellyfin, e.g. (objectClass=inetOrgPerson).</div>
                            </div>
                            <div class="inputContainer fldExternalAddressFilter">
                                <input is="emby-input" type="text" id="txtLdapAdminFilter" label="LDAP Admin Filter:" />
                                <div class="fieldDescription">The LDAP search filter to find administrative users for Jellyfin, e.g. (objectClass=JellyfinAdministrator).</div>
                            </div>
                            <div class="inputContainer fldExternalAddressFilter">
                                <input is="emby-input" type="text" id="txtLdapBindUser" label="LDAP Bind User:" />
                                <div class="fieldDescription">A bind user for LDAP search queries, required if your LDAP doesn't support anonymous bind.</div>
                            </div>
                            <div class="inputContainer fldExternalAddressFilter">
                                <input is="emby-input" type="password" id="txtLdapBindPassword" label="LDAP Bind User Password:" />
                                <div class="fieldDescription">The password for the LDAP search query user.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label>
                                    <input type="checkbox" is="emby-checkbox" id="chkEnableUserCreation" />
                                    <span>Enable User Creation</span>
                                </label>
                                <div class="fieldDescription checkboxFieldDescription">Enable user creation in Jellyfin on successful LDAP authentication. User must first exist in LDAP.</div>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label>
                                    <input type="checkbox" is="emby-checkbox" id="chkEnableCaseInsensitiveUsername" />
                                    <span>Enable Case Insensitive Username</span>
                                </label>
                                <div class="fieldDescription checkboxFieldDescription">Enable case insensitive username comparison</div>
                            </div>
                            <div class="folderAccessContainer">
                              <h2>${HeaderLibraryAccess}</h2>
                              <label class="checkboxContainer">
                                  <input type="checkbox" is="emby-checkbox" id="chkEnableAllFolders" />
                                  <span>${OptionEnableAccessToAllLibraries}</span>
                              </label>
                              <div class="folderAccessListContainer">
                                  <div class="folderAccess">
                                  </div>
                                  <div class="fieldDescription">${LibraryAccessHelp}</div>
                              </div>
                              <h2>
                                Per LDAP search Library Access
                                <button is="emby-button" type="button" class="fab btnNewKey submit emby-button" style="margin-left:1em" title="Add"> <span class="material-icons add" aria-hidden="true"></span> </button>
                              </h2>
                              <div class="fieldDescription">Select a set of Libraries to allow for different LDAP search matches. When a new LDAP user signs in 
                                for the first time, if they match one of these searches, their Library access will be set to the enabled
                                Libraries. If no match is found, the default Library access will be used.<br>
                                <p><b>NOTE:</b> Changes to these tables will not affect users that have already logged in using LDAP credentials.</p>
                              </div>
                              <br>
                              <table class="tblLdapSearch detailTable">
                                <caption class="clipForScreenReader">List of LDAP search queries and corresponing Library access.</caption>
                                <thead><tr>
                                  <th scope="col" class="detailTableHeaderCell"></th>
                                  <th scope="col" class="detailTableHeaderCell">LDAP Query</th>
                                  <th scope="col" class="detailTableHeaderCell">Libraries</th>
                                </tr></thead>
                                <tbody class="resultBody" id="ldapSearchLibraryTable">
                                  <tr>
                                  <td><button type="button" is="emby-button" 
                                    class="raised raised-mini btnRevoke emby-button"
                                    data-mini="true"
                                    title="Delete" style="margin:0;">Delete</button></td>
                                  <td class='ldapSearch'>ou=magic</td>
                                  <td class='ldapLibraries' data-libraries='feadbeef, f03f3ffa, dbcea80134'>Collections, Movies, Shows</td>
                                </tr>
                                </tbody>
                              </table>
                              </div>

                            </div>
                        <div>
                            <button is="emby-button" type="submit" data-theme="b" class="raised button-submit block">
                                <span>${Save}</span>
                            </button>
                            <button is="emby-button" type="button" class="raised button-cancel block btnCancel" onclick="history.back();">
                                <span>${ButtonCancel}</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>


        <script type="text/javascript">
            var LdapConfigurationPage = {
                pluginUniqueId: "958aad66-3784-4d2a-b89a-a7b6fab6e25c",
                
                txtLdapServer: document.querySelector("#txtLdapServer"),
                chkUseSsl: document.querySelector("#chkUseSsl"),
                chkUseStartTls: document.querySelector("#chkUseStartTls"),
                chkSkipSslVerify: document.querySelector("#chkSkipSslVerify"),
                txtLdapBaseDn: document.querySelector("#txtLdapBaseDn"),
                txtLdapPort: document.querySelector("#txtLdapPort"),
                txtLdapSearchAttributes: document.querySelector("#txtLdapSearchAttributes"),
                txtLdapUsernameAttribute: document.querySelector("#txtLdapUsernameAttribute"),
                txtLdapSearchFilter: document.querySelector("#txtLdapSearchFilter"),
                txtLdapAdminFilter: document.querySelector("#txtLdapAdminFilter"),
                txtLdapBindUser: document.querySelector("#txtLdapBindUser"),
                txtLdapBindPassword: document.querySelector("#txtLdapBindPassword"),
                chkEnableUserCreation: document.querySelector("#chkEnableUserCreation"),
                chkEnableCaseInsensitiveUsername: document.querySelector("#chkEnableCaseInsensitiveUsername"),
                chkEnableAllFolders: document.querySelector('#chkEnableAllFolders'),
                folderAccessList: document.querySelector('.folderAccess'),
            };

            if (!window.ldapInitialized) {
                window.ldapInitialized = true;
                window.addEventListener("pageshow", function (_) {
                    /* Only take action if the page being shown is 'LDAP-Auth' */
                    if (!event.detail || !event.detail.params || !event.detail.params.name || event.detail.params.name != 'LDAP-Auth') {
                        return;
                    }
 
                    Dashboard.showLoadingMsg();

                    window.ApiClient.getPluginConfiguration(LdapConfigurationPage.pluginUniqueId).then(function (config) {
                        LdapConfigurationPage.txtLdapServer.value = config.LdapServer || "ldap-server.contoso.com"; 
                        LdapConfigurationPage.chkUseSsl.checked = config.UseSsl;
                        LdapConfigurationPage.chkUseStartTls.checked = config.UseStartTls;
                        LdapConfigurationPage.chkSkipSslVerify.checked = config.SkipSslVerify;
                        LdapConfigurationPage.txtLdapBaseDn.value = config.LdapBaseDn || "o=domains,dc=contoso,dc=com";
                        LdapConfigurationPage.txtLdapPort.value = config.LdapPort || "389";
                        LdapConfigurationPage.txtLdapSearchAttributes.value = config.LdapSearchAttributes || "uid, cn, mail, displayName";
                        LdapConfigurationPage.txtLdapUsernameAttribute.value = config.LdapUsernameAttribute || "uid"; 
                        LdapConfigurationPage.txtLdapSearchFilter.value = config.LdapSearchFilter || "(memberOf=CN=JellyfinUsers,DC=contoso,DC=com)"; 
                        LdapConfigurationPage.txtLdapAdminFilter.value = config.LdapAdminFilter || "(enabledService=JellyfinAdministrator)";
                        LdapConfigurationPage.txtLdapBindUser.value = config.LdapBindUser || "CN=BindUser,DC=contoso,DC=com";
                        LdapConfigurationPage.txtLdapBindPassword.value = config.LdapBindPassword || "";
                        LdapConfigurationPage.chkEnableUserCreation.checked = config.CreateUsersFromLdap;
                        LdapConfigurationPage.chkEnableCaseInsensitiveUsername.checked = config.EnableCaseInsensitiveUsername;
                        config.EnableAllFolders = config.EnableAllFolders || false;
                        LdapConfigurationPage.chkEnableAllFolders.checked = config.EnableAllFolders;
                        /* Default to empty array if Enabled Folders is not set */
                        config.EnabledFolders = config.EnabledFolders || [];
                        LdapConfigurationPage.mediaFolders = loadMediaFolders(config).then((folders) => {
                          Dashboard.hideLoadingMsg();
                          return folders;
                        });
                    });

                    const updateFolderListVisibility = () => {
                        document.querySelector('.folderAccessContainer').style.display =
                            LdapConfigurationPage.chkEnableUserCreation.checked ? 'block' : 'none';
                    }

                    function loadMediaFolders(config) {
                      return window.ApiClient.getJSON(window.ApiClient.getUrl('Library/MediaFolders', {
                        IsHidden: false
                      })).then((mediaFolders) => {
                        if (!LdapConfigurationPage.folderAccessList) {
                          return mediaFolders;
                        }

                        let html = '';
                        html += '<h3 class="checkboxListLabel">${HeaderLibraries}</h3>';
                        html += '<div id="folderList" class="checkboxList paperList checkboxList-paperList">';

                        if (Array.isArray(mediaFolders.Items)) {
                          mediaFolders.Items.forEach((folder) => {
                            const isChecked = config.EnableAllFolders || config.EnabledFolders.indexOf(folder.Id) != -1;
                            const checkedAttribute = isChecked ? ' checked' : '';
                            html += '<label><input type="checkbox" is="emby-checkbox" class="chkFolder" data-id="' +
                              folder.Id + '" ' + checkedAttribute + '><span>' + folder.Name +
                                '</span></label>';
                          });
                        }

                        html += '</div>';
                        LdapConfigurationPage.folderAccessList.innerHTML = html;
                        /* Only show these options if Jellyfin user creation is enabled on successful LDAP authentication */
                        updateFolderListVisibility();
                        LdapConfigurationPage.chkEnableUserCreation.addEventListener('change', updateFolderListVisibility);
                        /* Set up event handlers for tracking folder enabling/disabling */
                        Array.prototype.forEach.call(document.querySelectorAll('#folderList input'), (folder) => {
                          folder.addEventListener('change', (event) => {
                            const folders = document.querySelectorAll('#folderList input');
                            let count = 0;
                            Array.prototype.forEach.call(folders, folder => folder.checked && count++);
                            LdapConfigurationPage.chkEnableAllFolders.checked = count == folders.length;
                          });
                        });
                        LdapConfigurationPage.chkEnableAllFolders.addEventListener('change', (event) => {
                          Array.prototype.forEach.call(document.querySelectorAll('#folderList input'), (folder) => {
                            folder.checked = event.currentTarget.checked;
                          });
                        });

                        return mediaFolders;
                      });
                    }
                });

                document.querySelector(".esqConfigurationForm").addEventListener("submit", function(e){
                    e.preventDefault();
                    Dashboard.showLoadingMsg();

                    window.ApiClient.getPluginConfiguration(LdapConfigurationPage.pluginUniqueId).then(function (config) {
                        config.LdapServer = LdapConfigurationPage.txtLdapServer.value;
                        config.UseSsl = LdapConfigurationPage.chkUseSsl.checked;
                        config.UseStartTls = LdapConfigurationPage.chkUseStartTls.checked;
                        config.SkipSslVerify = LdapConfigurationPage.chkSkipSslVerify.checked;
                        config.LdapBaseDn = LdapConfigurationPage.txtLdapBaseDn.value;
                        config.LdapPort = parseInt(LdapConfigurationPage.txtLdapPort.value || "389");
                        config.LdapSearchAttributes = LdapConfigurationPage.txtLdapSearchAttributes.value;
                        config.LdapUsernameAttribute = LdapConfigurationPage.txtLdapUsernameAttribute.value;
                        config.LdapSearchFilter = LdapConfigurationPage.txtLdapSearchFilter.value;
                        config.LdapAdminFilter = LdapConfigurationPage.txtLdapAdminFilter.value;
                        config.LdapBindUser = LdapConfigurationPage.txtLdapBindUser.value;
                        config.LdapBindPassword = LdapConfigurationPage.txtLdapBindPassword.value;
                        config.CreateUsersFromLdap = LdapConfigurationPage.chkEnableUserCreation.checked;
                        config.EnableCaseInsensitiveUsername = LdapConfigurationPage.chkEnableCaseInsensitiveUsername.checked;
                        /* Map the set of checked input items to an array of library Id's */
                        config.EnableAllFolders = LdapConfigurationPage.chkEnableAllFolders.checked || false;
                        let folders = document.querySelectorAll('#folderList input');
                        folders = Array.prototype.filter.call(folders, folder => folder.checked)
                          .map(folder => folder.getAttribute("data-id"));
                        config.EnabledFolders = folders;
                        let ldapMatchFolders = document.querySelectorAll('#ldapSearchLibraryTable tr');
                        ldapMatchFolders = Array.prototype.map.call(ldapMatchFolders, tr => {
                          return { 
                            search: tr.querySelector('.ldapSearch').textContent,
                            libraries: tr.querySelector('.ldapLibraries')
                              .getAttribute('data-libraries')
                              .split(',')
                              .map(text => text.trim())
                          };  
                        });
                        console.log(ldapMatchFolders);
                        config.LdapMatchFolders = ldapMatchFolders;
                        window.ApiClient.updatePluginConfiguration(LdapConfigurationPage.pluginUniqueId, config).then(Dashboard.processPluginConfigurationUpdateResult);
                    });

                    // Disable default form submission
                    return false;
                });
            }
        </script>
    </div>
</body>
</html>
